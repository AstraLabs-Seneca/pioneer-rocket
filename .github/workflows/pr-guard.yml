name: PR Guard

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

jobs:
  validate-pr-description:
    runs-on: ubuntu-latest
    steps:
      - name: Validate linked issue and evidence
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const pr = context.payload.pull_request;
            const body = (pr.body || '').replace(/\r/g, '');

            if (pr.draft) {
              core.info('Draft PR detected. Skipping strict checks until ready for review.');
              return;
            }

            const errors = [];

            const hasLinkedIssue = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#\d+/i.test(body);
            if (!hasLinkedIssue) {
              errors.push('Add a linked issue in the PR body, for example: `Closes #123`.');
            }

            const evidenceSection = body.match(/##\s+Evidence([\s\S]*?)(?:\n##\s+|$)/i);
            if (!evidenceSection) {
              errors.push('Add a `## Evidence` section in the PR body.');
            } else {
              const evidenceText = evidenceSection[1].trim();
              const placeholderOnly = /^-?\s*Screenshots\/logs\/notes:\s*$/i.test(evidenceText);
              if (!evidenceText || placeholderOnly) {
                errors.push('Fill the `## Evidence` section with real proof (log, screenshot, export, or artifact).');
              }
            }

            if (errors.length > 0) {
              core.setFailed(errors.join('\n'));
            } else {
              core.info('PR Guard checks passed.');
            }
